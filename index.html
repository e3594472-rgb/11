<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚ö° Hogwarts Tic-Tac-Toe ¬∑ Harry Potter theme</title>
  <!-- Google Fonts for magic vibe -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Henny+Penny&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at 20% 30%, #1a1a2f, #0a0c1a);
      font-family: 'Quicksand', sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem;
      transition: background 0.5s ease;
    }

    /* day/night themes */
    body.theme-day {
      background: radial-gradient(circle at 20% 30%, #f8eedb, #e3cfa5);
    }

    /* main floating card ‚Äì magical appearance */
    .game-container {
      width: 100%;
      max-width: 750px;
      background: rgba(18, 14, 30, 0.7);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 4rem 4rem 3rem 3rem;
      box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 0 2px #b3925c inset, 0 0 30px #dbb46a;
      padding: 1.8rem 1.2rem 2.2rem;
      transition: background 0.3s, box-shadow 0.3s;
    }

    body.theme-day .game-container {
      background: rgba(255, 245, 215, 0.75);
      box-shadow: 0 20px 30px rgba(90, 60, 20, 0.3), 0 0 0 2px #ab7f4c inset, 0 0 30px #fad675;
    }

    /* top bar ‚Äì exactly three buttons */
    .top-bar {
      display: flex;
      justify-content: center;
      gap: 1.2rem;
      flex-wrap: wrap;
      margin-bottom: 1.5rem;
    }

    .magic-btn {
      background: #2a2338;
      border: none;
      border-radius: 4rem;
      padding: 0.8rem 2rem;
      font-family: 'Quicksand', sans-serif;
      font-weight: 700;
      font-size: 1.2rem;
      color: #f3e5c7;
      box-shadow: 0 8px 0 #12101a, 0 4px 20px #7d613a;
      cursor: pointer;
      transition: all 0.12s ease;
      border: 1px solid #c8a66b;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      letter-spacing: 0.5px;
    }

    .magic-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 0 #12101a, 0 8px 25px #dbb86b;
      background: #3e2f52;
    }

    .magic-btn:active {
      transform: translateY(5px);
      box-shadow: 0 4px 0 #12101a, 0 4px 15px #dbb86b;
    }

    body.theme-day .magic-btn {
      background: #c9a76b;
      color: #271f0e;
      box-shadow: 0 8px 0 #7a5d32, 0 4px 20px #b6914b;
      border-color: #f5e1a6;
    }

    body.theme-day .magic-btn:hover {
      background: #ddb87c;
    }

    /* scoreboard */
    .score-panel {
      display: flex;
      justify-content: space-around;
      background: #1e182bb3;
      border-radius: 6rem;
      padding: 0.9rem 0.5rem;
      margin: 0 0.5rem 1.5rem 0.5rem;
      border: 1px solid #bfa065;
      backdrop-filter: blur(4px);
      font-weight: 700;
      color: #ffefcf;
    }

    body.theme-day .score-panel {
      background: #dbbc87b3;
      color: #2f1f08;
    }

    .score-item {
      display: flex;
      gap: 0.8rem;
      align-items: center;
      font-size: 1.3rem;
    }

    .score-value {
      background: #0200087a;
      border-radius: 40%;
      padding: 0.2rem 1rem;
      font-size: 1.8rem;
      border: 1px solid #e9c47e;
    }

    /* victory banner (non‚Äëoverlapping) */
    .victory-banner {
      text-align: center;
      font-size: 1.8rem;
      font-family: 'Henny Penny', cursive;
      min-height: 3.5rem;
      margin: 0 0 1.2rem 0;
      padding: 0.4rem;
      color: #ffdfa0;
      text-shadow: 2px 2px 0 #3a280e, 0 0 15px gold;
      background: #262036b0;
      border-radius: 4rem;
    }

    body.theme-day .victory-banner {
      color: #3a250a;
      background: #edd9bbb0;
      text-shadow: 1px 1px 0 #fff6d0;
    }

    /* fluid vmin board ‚Äì perfect square */
    .board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1.2vmin;
      width: 76vmin;
      height: 76vmin;
      margin: 0.2rem auto 2rem;
      background: transparent;
    }

    .cell {
      background: #262033d9;
      backdrop-filter: blur(4px);
      border-radius: 2.8vmin;
      box-shadow: 0 0 0 2px #cfa66b, 0 10px 20px #00000080, inset 0 -4px 8px #ffffff30;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10vmin;
      font-weight: 700;
      color: #f7e2bc;
      transition: all 0.15s;
      cursor: pointer;
      user-select: none;
      touch-action: manipulation;
      border: none;
      width: 100%;
      height: 100%;
      font-family: 'Henny Penny', 'Quicksand', cursive;
    }

    body.theme-day .cell {
      background: #f5e7d3e0;
      color: #382a12;
      box-shadow: 0 0 0 2px #9e7a48, 0 8px 15px #836e37b0;
    }

    .cell.win-highlight {
      background: radial-gradient(circle at 30% 30%, #fad159, #ca9f40);
      color: #1f1305;
      box-shadow: 0 0 30px 10px #ffd966, 0 0 0 3px #fff6c1;
    }

    .cell:active:not(:disabled) {
      transform: scale(0.93);
    }

    .cell:disabled {
      cursor: not-allowed;
      opacity: 0.9;
    }

    /* quiz modal */
    .quiz-backdrop {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0b0710e0;
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      transition: 0.2s;
    }

    .quiz-backdrop.hidden {
      display: none;
    }

    .quiz-modal {
      background: #1e1932f0;
      border: 3px solid #b28f57;
      border-radius: 4rem;
      padding: 2rem 2.5rem;
      max-width: 550px;
      width: 90%;
      color: #fff2da;
      box-shadow: 0 30px 50px black, 0 0 60px #ffd966;
      text-align: center;
    }

    body.theme-day .quiz-modal {
      background: #f7eeddf0;
      color: #2e210a;
    }

    .quiz-question {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 2rem;
      font-family: 'Henny Penny', cursive;
      line-height: 1.4;
    }

    .quiz-options {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 2rem 0;
    }

    .quiz-option {
      background: #342d46;
      border: 2px solid #cba568;
      border-radius: 3rem;
      padding: 1rem 1.5rem;
      font-size: 1.4rem;
      font-weight: 600;
      color: #fbeecc;
      cursor: pointer;
      transition: all 0.15s;
    }

    .quiz-option:hover {
      background: #4f3f63;
      transform: scale(1.02);
      border-color: #f5d88c;
    }

    body.theme-day .quiz-option {
      background: #ddc099;
      color: #261c08;
    }

    body.theme-day .quiz-option:hover {
      background: #ecd9b0;
    }

    .quiz-feedback {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 1rem 0;
      min-height: 3rem;
      color: #ffd966;
      text-shadow: 2px 2px 0 #3a280e;
    }

    body.theme-day .quiz-feedback {
      color: #7a5a28;
      text-shadow: 1px 1px 0 #ffeeaa;
    }

    /* customization dialog */
    .dialog-backdrop {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #0b0710c0;
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: 0.2s;
    }

    .dialog-backdrop.hidden {
      display: none;
    }

    .customize-dialog {
      background: #1e1932f0;
      border: 3px solid #b28f57;
      border-radius: 4rem;
      padding: 2rem 2.2rem;
      max-width: 500px;
      width: 90%;
      color: #fff2da;
      box-shadow: 0 30px 50px black, 0 0 50px #e9be74;
    }

    body.theme-day .customize-dialog {
      background: #f7eeddf0;
      color: #2e210a;
    }

    .dialog-row {
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.7rem;
      font-size: 1.2rem;
    }

    .dialog-row label {
      font-weight: 700;
      min-width: 140px;
    }

    .dialog-row select, .dialog-row button {
      background: #342d46;
      border: 2px solid #cba568;
      border-radius: 3rem;
      padding: 0.6rem 1.5rem;
      color: #fbeecc;
      font-weight: 600;
      font-size: 1.1rem;
      cursor: pointer;
    }

    body.theme-day .dialog-row select,
    body.theme-day .dialog-row button {
      background: #ddc099;
      color: #261c08;
    }

    .close-dialog-btn {
      width: 100%;
      margin-top: 1.8rem;
      background: #aa7f4b;
      border: none;
      border-radius: 3rem;
      padding: 0.9rem;
      font-size: 1.4rem;
      font-weight: bold;
    }

    /* confetti canvas (no DOM nodes) */
    #confetti-canvas {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 999;
    }

    /* accessibility */
    .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; }
  </style>
</head>
<body>
  <div class="game-container">
    <!-- three buttons top bar -->
    <div class="top-bar">
      <button class="magic-btn" id="newRoundBtn">ü™Ñ New Round</button>
      <button class="magic-btn" id="customizeBtn">üîÆ Customize</button>
      <button class="magic-btn" id="resetScoresBtn">‚ö° Reset Scores</button>
    </div>

    <!-- victory banner -->
    <div class="victory-banner" id="victoryBanner" role="status" aria-live="polite"></div>

    <!-- scoreboard -->
    <div class="score-panel">
      <div class="score-item"><span>ü¶Å X</span><span class="score-value" id="scoreX">0</span></div>
      <div class="score-item"><span>ü§ç Draws</span><span class="score-value" id="scoreDraw">0</span></div>
      <div class="score-item"><span>üêç O</span><span class="score-value" id="scoreO">0</span></div>
    </div>

    <!-- tic-tac-toe grid with ARIA roles -->
    <div class="board" id="board" role="grid" aria-label="Tic tac toe board"></div>
  </div>

  <!-- customize dialog -->
  <div class="dialog-backdrop hidden" id="dialogBackdrop">
    <div class="customize-dialog" role="dialog" aria-modal="true" aria-labelledby="dialogTitle">
      <h2 id="dialogTitle" style="text-align:center; margin-bottom:1.8rem; font-family:'Henny Penny';">‚ú® Customize magic ‚ú®</h2>
      <div class="dialog-row">
        <label>Theme:</label>
        <select id="themeSelect">
          <option value="night" selected>Night (Hogwarts)</option>
          <option value="day">Day (Great Hall)</option>
        </select>
      </div>
      <div class="dialog-row">
        <label>Glyphs:</label>
        <select id="glyphSelect">
          <option value="standard">Standard X / O</option>
          <option value="magic">üìú Hogwarts letter / ü¶â Owl</option>
        </select>
      </div>
      <div class="dialog-row">
        <label>Mode:</label>
        <select id="modeSelect">
          <option value="2player">2‚Äëplayer</option>
          <option value="ai" selected>vs AI</option>
        </select>
      </div>
      <div class="dialog-row">
        <label>First move:</label>
        <select id="firstMoveSelect">
          <option value="X">X (Gryffindor)</option>
          <option value="O">O (Slytherin)</option>
        </select>
      </div>
      <div class="dialog-row">
        <label>AI discipline:</label>
        <select id="aiDisciplineSelect">
          <option value="perfect">Perfect (Dumbledore)</option>
          <option value="pragmatic">Pragmatic (McGonagall)</option>
          <option value="reckless">Reckless (Peeves)</option>
        </select>
      </div>
      <button class="close-dialog-btn magic-btn" id="closeDialogBtn">Save & close</button>
    </div>
  </div>

  <!-- quiz modal (hidden by default) -->
  <div class="quiz-backdrop hidden" id="quizBackdrop">
    <div class="quiz-modal" role="dialog" aria-modal="true" aria-labelledby="quizQuestion">
      <div class="quiz-question" id="quizQuestion"></div>
      <div class="quiz-options" id="quizOptions"></div>
      <div class="quiz-feedback" id="quizFeedback"></div>
    </div>
  </div>

  <!-- confetti canvas (pure canvas, no DOM nodes) -->
  <canvas id="confetti-canvas" aria-hidden="true"></canvas>

  <script>
    (function() {
      // ---------- QUIZ DATABASE ----------
      const quizData = [
        ["I ___ football every Sunday.","play","am playing","plays",1],
        ["Look! The cat ___ on the sofa.","sleep","sleeps","is sleeping",3],
        ["My mom ___ coffee in the morning.","drink","drinks","is drinking",2],
        ["We ___ TV now.","watch","watches","are watching",3],
        ["He ___ his teeth twice a day.","brush","brushes","is brushing",2],
        ["They ___ to the park at the moment.","go","goes","are going",3],
        ["The sun ___ in the east.","rise","rises","is rising",2],
        ["Listen! The birds ___.","sing","sings","are singing",3],
        ["Sarah ___ her homework every evening.","do","does","is doing",2],
        ["I ___ a book right now.","read","reads","am reading",3],
        ["Tom ___ to music on Saturdays.","listen","listens","is listening",2],
        ["Shh! The baby ___.","sleep","sleeps","is sleeping",3],
        ["We ___ pizza on Fridays.","eat","eats","are eating",1],
        ["Look! It ___ outside.","rain","rains","is raining",3],
        ["My dad ___ to work by car.","go","goes","is going",2],
        ["The children ___ in the garden now.","play","plays","are playing",3],
        ["She ___ English very well.","speak","speaks","is speaking",2],
        ["I ___ my room at the moment.","clean","cleans","am cleaning",3],
        ["Birds ___ in the sky.","fly","flies","are flying",1],
        ["He ___ a shower right now.","take","takes","is taking",3]
      ];

      // ---------- state ----------
      let board = Array(9).fill('');
      let currentPlayer = 'X';
      let gameOver = false;
      let winCombo = null;               // indices of winning line
      let scores = { X: 0, O: 0, draws: 0 };

      // user settings (match dialog defaults)
      let theme = 'night';
      let glyphStyle = 'standard';       // 'standard' or 'magic'
      let mode = 'ai';
      let firstMove = 'X';
      let aiDiscipline = 'perfect';

      // pending move data (stores which cell player tried to click)
      let pendingCellIndex = null;

      // DOM elements
      const boardEl = document.getElementById('board');
      const victoryBanner = document.getElementById('victoryBanner');
      const scoreX = document.getElementById('scoreX');
      const scoreO = document.getElementById('scoreO');
      const scoreDraw = document.getElementById('scoreDraw');
      const newRoundBtn = document.getElementById('newRoundBtn');
      const customizeBtn = document.getElementById('customizeBtn');
      const resetScoresBtn = document.getElementById('resetScoresBtn');
      const dialogBackdrop = document.getElementById('dialogBackdrop');
      const closeDialogBtn = document.getElementById('closeDialogBtn');
      const themeSelect = document.getElementById('themeSelect');
      const glyphSelect = document.getElementById('glyphSelect');
      const modeSelect = document.getElementById('modeSelect');
      const firstMoveSelect = document.getElementById('firstMoveSelect');
      const aiDisciplineSelect = document.getElementById('aiDisciplineSelect');

      // quiz elements
      const quizBackdrop = document.getElementById('quizBackdrop');
      const quizQuestion = document.getElementById('quizQuestion');
      const quizOptions = document.getElementById('quizOptions');
      const quizFeedback = document.getElementById('quizFeedback');

      // canvas confetti
      const canvas = document.getElementById('confetti-canvas');
      let ctx = canvas.getContext('2d');
      let particles = [];
      let animFrame = null;
      const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resizeCanvas);
      resizeCanvas();

      // ----- confetti (canvas only) -----
      function triggerConfetti() {
        if (prefersReducedMotion) return;
        particles = [];
        for (let i = 0; i < 70; i++) {
          particles.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height * 0.2,
            size: Math.random() * 10 + 4,
            speedY: Math.random() * 5 + 3,
            speedX: (Math.random() - 0.5) * 2.5,
            color: `hsl(${Math.random() * 30 + 35}, 90%, 65%)`, // golden/warm
            rotation: Math.random() * 360,
          });
        }
        if (animFrame) cancelAnimationFrame(animFrame);
        drawConfetti();
      }

      function drawConfetti() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let still = false;
        for (let p of particles) {
          p.y += p.speedY * 0.5;
          p.x += p.speedX;
          p.rotation += 1;
          if (p.y < canvas.height) still = true;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rotation * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size * 0.4);
          ctx.restore();
        }
        if (still) {
          animFrame = requestAnimationFrame(drawConfetti);
        } else {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
      }

      function stopConfetti() {
        if (animFrame) cancelAnimationFrame(animFrame);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }

      // ----- render board with glyphs -----
      function renderBoard() {
        boardEl.innerHTML = '';
        for (let i = 0; i < 9; i++) {
          const cell = document.createElement('button');
          cell.className = 'cell';
          if (winCombo && winCombo.includes(i)) cell.classList.add('win-highlight');
          cell.setAttribute('role', 'gridcell');
          cell.setAttribute('aria-label', `cell ${i+1} ${board[i] || 'empty'}`);
          cell.dataset.index = i;

          // GLYPHS: Standard X/O  OR  'üìú' (Hogwarts letter) / 'ü¶â' (owl)
          let displayChar = board[i];
          if (board[i] === 'X' && glyphStyle === 'magic') displayChar = 'üìú';    // Hogwarts letter
          else if (board[i] === 'O' && glyphStyle === 'magic') displayChar = 'ü¶â'; // owl
          else if (board[i] === 'X') displayChar = 'X';
          else if (board[i] === 'O') displayChar = 'O';
          else displayChar = '';

          cell.textContent = displayChar;
          cell.disabled = !!board[i] || gameOver;
          cell.addEventListener('click', () => cellClick(i));
          boardEl.appendChild(cell);
        }
        // update scores
        scoreX.textContent = scores.X;
        scoreO.textContent = scores.O;
        scoreDraw.textContent = scores.draws;
      }

      // ----- win check -----
      function checkWinner() {
        const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for (let l of lines) {
          const [a,b,c] = l;
          if (board[a] && board[a] === board[b] && board[a] === board[c]) {
            winCombo = l;
            gameOver = true;
            return board[a];
          }
        }
        if (board.every(cell => cell !== '')) {
          gameOver = true;
          winCombo = null;
          return 'draw';
        }
        return null;
      }

      function handleGameEnd(winner) {
        if (winner === 'X') {
          scores.X++;
          victoryBanner.textContent = 'ü¶Å X wins! Gryffindor triumphs!';
          triggerConfetti();
        } else if (winner === 'O') {
          scores.O++;
          victoryBanner.textContent = 'üêç O wins! Slytherin wins!';
          triggerConfetti();
        } else if (winner === 'draw') {
          scores.draws++;
          victoryBanner.textContent = "‚ú® It's a draw! Magical stalemate ‚ú®";
        }
        renderBoard();
      }

      function resetBoard() {
        board = Array(9).fill('');
        gameOver = false;
        winCombo = null;
        currentPlayer = firstMove;
        victoryBanner.textContent = '';
        stopConfetti();
        renderBoard();

        // if AI mode and AI should move (AI is opposite of firstMove)
        if (mode === 'ai' && !gameOver) {
          const aiPlayer = (firstMove === 'X') ? 'O' : 'X';
          if (currentPlayer === aiPlayer) {
            window.setTimeout(makeAIMove, 200);
          }
        }
      }

      // ----- QUIZ FUNCTIONS -----
      function showQuiz(cellIndex) {
        // store which cell player wants to play
        pendingCellIndex = cellIndex;
        
        // pick random question
        const randomIndex = Math.floor(Math.random() * quizData.length);
        const q = quizData[randomIndex];
        
        // set question text
        quizQuestion.textContent = q[0];
        
        // create option buttons
        quizOptions.innerHTML = '';
        for (let i = 1; i <= 3; i++) {
          const optBtn = document.createElement('div');
          optBtn.className = 'quiz-option';
          optBtn.textContent = q[i];
          optBtn.dataset.optIndex = i;
          optBtn.addEventListener('click', () => checkAnswer(i, q[4])); // q[4] is correct answer number
          quizOptions.appendChild(optBtn);
        }
        
        // clear feedback
        quizFeedback.textContent = '';
        
        // show modal
        quizBackdrop.classList.remove('hidden');
      }

      function checkAnswer(selected, correct) {
        if (selected === correct) {
          // correct answer
          quizFeedback.textContent = '‚ú® Correct! ‚ú®';
          quizFeedback.style.color = '#7cf9b0';
          
          // close modal after short delay and make the move
          setTimeout(() => {
            quizBackdrop.classList.add('hidden');
            if (pendingCellIndex !== null) {
              executeMove(pendingCellIndex);
              pendingCellIndex = null;
            }
          }, 800);
        } else {
          // wrong answer
          quizFeedback.textContent = '‚ùå Try again! ‚ùå';
          quizFeedback.style.color = '#ff9f9f';
          
          // pick a new question after a short delay (but keep same pending cell)
          setTimeout(() => {
            if (pendingCellIndex !== null) {
              showQuiz(pendingCellIndex); // new random question
            }
          }, 1000);
        }
      }

      // ----- GAME MOVE EXECUTION (called after correct quiz) -----
      function executeMove(index) {
        if (gameOver || board[index] !== '') return;

        // in AI mode, block if it's not human's turn
        if (mode === 'ai') {
          const humanPlayer = firstMove;
          if (currentPlayer !== humanPlayer) return;
        }

        board[index] = currentPlayer;
        renderBoard();
        const winner = checkWinner();
        if (winner) {
          handleGameEnd(winner);
        } else {
          // switch player
          currentPlayer = currentPlayer === 'X' ? 'O' : 'X';
          renderBoard();
          // if AI mode and now AI turn
          if (mode === 'ai' && !gameOver) {
            const aiPlayer = (firstMove === 'X') ? 'O' : 'X';
            if (currentPlayer === aiPlayer) {
              window.setTimeout(makeAIMove, 250);
            }
          }
        }
      }

      // human move ‚Äì now shows quiz first
      function cellClick(index) {
        if (gameOver || board[index] !== '') return;

        // in AI mode, block if it's not human's turn
        if (mode === 'ai') {
          const humanPlayer = firstMove;
          if (currentPlayer !== humanPlayer) return;
        }

        // Show quiz instead of making move immediately
        showQuiz(index);
      }

      // ---------- AI with minimax + disciplines ----------
      function evaluate(boardArr) {
        const lines = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
        for (let l of lines) {
          const [a,b,c] = l;
          if (boardArr[a] && boardArr[a] === boardArr[b] && boardArr[a] === boardArr[c]) {
            return boardArr[a] === 'X' ? 10 : -10;
          }
        }
        return 0;
      }

      function minimax(boardArr, depth, isMax) {
        const score = evaluate(boardArr);
        if (score === 10) return 10 - depth;
        if (score === -10) return depth - 10;
        if (!boardArr.includes('')) return 0;

        if (isMax) {
          let best = -Infinity;
          for (let i = 0; i < 9; i++) {
            if (boardArr[i] === '') {
              boardArr[i] = 'X';
              best = Math.max(best, minimax(boardArr, depth + 1, false));
              boardArr[i] = '';
            }
          }
          return best;
        } else {
          let best = Infinity;
          for (let i = 0; i < 9; i++) {
            if (boardArr[i] === '') {
              boardArr[i] = 'O';
              best = Math.min(best, minimax(boardArr, depth + 1, true));
              boardArr[i] = '';
            }
          }
          return best;
        }
      }

      function getAIMoveIndex() {
        const aiPlayer = (firstMove === 'X') ? 'O' : 'X';
        let bestScore = -Infinity;
        let candidateMoves = [];

        for (let i = 0; i < 9; i++) {
          if (board[i] === '') {
            board[i] = aiPlayer;
            let score = minimax([...board], 0, aiPlayer === 'X' ? false : true);
            board[i] = '';

            // discipline filter
            if (aiDiscipline === 'perfect') {
              if (score > bestScore) {
                bestScore = score;
                candidateMoves = [i];
              } else if (score === bestScore) candidateMoves.push(i);
            } 
            else if (aiDiscipline === 'pragmatic') {
              // 25% random move (any empty)
              if (Math.random() < 0.25) candidateMoves.push(i);
              else {
                if (score > bestScore) { bestScore = score; candidateMoves = [i]; }
                else if (score === bestScore) candidateMoves.push(i);
              }
            } 
            else if (aiDiscipline === 'reckless') {
              // 60% random move, else best
              if (Math.random() < 0.6) candidateMoves.push(i);
              else {
                if (score > bestScore) { bestScore = score; candidateMoves = [i]; }
                else if (score === bestScore) candidateMoves.push(i);
              }
            }
          }
        }

        if (candidateMoves.length === 0) return null;
        return candidateMoves[Math.floor(Math.random() * candidateMoves.length)];
      }

      function makeAIMove() {
        if (gameOver) return;
        const aiPlayer = (firstMove === 'X') ? 'O' : 'X';
        const index = getAIMoveIndex();
        if (index === null || board[index] !== '') return; // no moves left

        board[index] = aiPlayer;
        renderBoard();
        const winner = checkWinner();
        if (winner) {
          handleGameEnd(winner);
        } else {
          currentPlayer = firstMove; // back to human
          renderBoard();
        }
      }

      // ----- event listeners -----
      newRoundBtn.addEventListener('click', resetBoard);

      resetScoresBtn.addEventListener('click', () => {
        scores = { X:0, O:0, draws:0 };
        victoryBanner.textContent = '';
        renderBoard();
        stopConfetti();
      });

      customizeBtn.addEventListener('click', () => {
        themeSelect.value = theme;
        glyphSelect.value = glyphStyle;
        modeSelect.value = mode;
        firstMoveSelect.value = firstMove;
        aiDisciplineSelect.value = aiDiscipline;
        dialogBackdrop.classList.remove('hidden');
      });

      closeDialogBtn.addEventListener('click', () => {
        theme = themeSelect.value;
        glyphStyle = glyphSelect.value;
        mode = modeSelect.value;
        firstMove = firstMoveSelect.value;
        aiDiscipline = aiDisciplineSelect.value;

        document.body.classList.toggle('theme-day', theme === 'day');

        // apply glyphs immediately
        renderBoard();
        dialogBackdrop.classList.add('hidden');
      });

      dialogBackdrop.addEventListener('click', (e) => {
        if (e.target === dialogBackdrop) dialogBackdrop.classList.add('hidden');
      });

      // allow closing quiz by clicking backdrop? better not, to avoid cheating
      // but we'll keep it as is

      // initial render
      renderBoard();
      resetBoard(); // sets board according to firstMove
    })();
  </script>
</body>
</html>